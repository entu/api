AWSTemplateFormatVersion: '2010-09-09'
Transform: AWS::Serverless-2016-10-31
Description: Entu API

Parameters:
  GitSha:
    Type: String
  DomainName:
    Type: String
  CertificateArn:
    Type: String
  HostedZoneId:
    Type: String
  MongoDbUrl:
    Type: String
  JwtSecret:
    Type: String
  Architecture:
    Type: String
    Default: arm64
  # VpcSubnet:
  #   Type: AWS::SSM::Parameter::Value<List<AWS::EC2::Subnet::Id>>
  #   Description: SSM Parameter store key of type StringList with the list of VPC Subnet to be used by Lambda function
  #   Default: /MyVpcSubnet
  # VpcSecurityGroup:
  #   Type: AWS::SSM::Parameter::Value<AWS::EC2::SecurityGroup::Id>
  #   Description: SSM Parameter store key of type String with the VPC Security Group to be used by Lambda function
  #   Default: /MyVpcSecurityGroup

Globals:
  Function:
    Environment:
      Variables:
        NODE_ENV: production
        GIT_SHA: !Ref GitSha
        MONGODB_URL: !Ref MongoDbUrl
        JWT_SECRET: !Ref JwtSecret
    Architectures:
      - !Ref Architecture
    Runtime: nodejs14.x
    MemorySize: 256
    Timeout: 30
    Layers:
      - !Ref LambdaLayer
    # Properties:
    #   VpcConfig:
    #     SubnetIds: !Ref VpcSubnet
    #     SecurityGroupIds:
    #       - !Ref VpcSecurityGroup

Resources:
  HttpApi:
    Type: AWS::Serverless::HttpApi
    Properties:
      Domain:
        DomainName: !Ref DomainName
        CertificateArn: !Ref CertificateArn
        EndpointConfiguration: REGIONAL
        Route53:
          HostedZoneId: !Ref HostedZoneId
      CorsConfiguration:
        AllowMethods:
          - GET
          - POST
          - OPTIONS
          - DELETE
          - PUT
        AllowHeaders:
          - Authorization
          - Access-Control-Allow-Origin
          - Content-Type
        AllowOrigins:
          - "*"

  LambdaLayer:
    Type: AWS::Serverless::LayerVersion
    Properties:
      LayerName: !Sub "${AWS::StackName}-dependencies"
      Description: Entu API dependencies
      ContentUri: layers
      CompatibleRuntimes:
        - nodejs14.x
      RetentionPolicy: Delete
    Metadata:
      BuildArchitecture: !Ref Architecture

  FunctionAccountGet:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-account-get"
      CodeUri: functions/account/
      Handler: get.handler
      Description: Returns account info and usage statistics
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /account
            Method: GET
            ApiId: !Ref HttpApi

  FunctionAuthGet:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-auth-get"
      CodeUri: functions/auth/
      Handler: get.handler
      Description: Authenticates user by API key
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /auth
            Method: GET
            ApiId: !Ref HttpApi

  FunctionEntityListGet:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-entity-list-get"
      CodeUri: functions/entity/
      Handler: get.handler
      Description: Get list of entities
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /entity
            Method: GET
            ApiId: !Ref HttpApi

  FunctionEntityListPost:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-entity-list-post"
      CodeUri: functions/entity/
      Handler: post.handler
      Description: Create new entity
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /entity
            Method: POST
            ApiId: !Ref HttpApi

  FunctionEntityGet:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-entity-get"
      CodeUri: functions/entity/
      Handler: get.handler
      Description: Get one entity with given id
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /entity/{_id}
            Method: GET
            ApiId: !Ref HttpApi

  FunctionEntityPost:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-entity-post"
      CodeUri: functions/entity/
      Handler: get.handler
      Description: Add new properties to existing entity
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /entity/{_id}
            Method: POST
            ApiId: !Ref HttpApi

  FunctionEntityDelete:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-entity-delete"
      CodeUri: functions/entity/
      Handler: get.handler
      Description: Delete entity with given id
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /entity/{_id}
            Method: DELETE
            ApiId: !Ref HttpApi

  FunctionPropertyGet:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-property-get"
      CodeUri: functions/property/
      Handler: get.handler
      Description: Get property with given id
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /property/{_id}
            Method: GET
            ApiId: !Ref HttpApi

  FunctionPropertyDelete:
    Type: AWS::Serverless::Function
    Properties:
      FunctionName: !Sub "${AWS::StackName}-property-delete"
      CodeUri: functions/property/
      Handler: get.handler
      Description: Delete property with given id
      Policies:
        - SSMParameterReadPolicy:
            ParameterName: "entu-api-*"
      Events:
        HttpApiEvent:
          Type: HttpApi
          Properties:
            Path: /property/{_id}
            Method: DELETE
            ApiId: !Ref HttpApi

Outputs:
  HttpApiUrl:
    Description: "API Gateway endpoint URL for Prod stage"
    Value: !Sub "https://${HttpApi}.execute-api.${AWS::Region}.${AWS::URLSuffix}"
